name: Release Please

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      releases_created: ${{ steps.release.outputs.releases_created }}
      paths_released: ${{ steps.release.outputs.paths_released }}
      core_release_created: ${{ steps.release.outputs['packages/core--release_created'] }}
      core_tag_name: ${{ steps.release.outputs['packages/core--tag_name'] }}
      mcp_release_created: ${{ steps.release.outputs['packages/mcp--release_created'] }}
      mcp_tag_name: ${{ steps.release.outputs['packages/mcp--tag_name'] }}

    steps:
      - uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}

      - uses: googleapis/release-please-action@v4
        id: release
        with:
          token: ${{ steps.app-token.outputs.token }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

  build-binaries:
    needs: release-please
    if: ${{ needs.release-please.outputs.mcp_release_created == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build binaries
        run: bun scripts/build-release.ts

      - name: Upload release artifacts
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release upload ${{ needs.release-please.outputs.mcp_tag_name }} \
            dist/release/* \
            --clobber

  publish:
    needs: release-please
    if: ${{ needs.release-please.outputs.releases_created == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build packages
        run: bun run build

      - name: Publish @pleaseai/mcp-core
        if: ${{ needs.release-please.outputs.core_release_created == 'true' }}
        run: bun publish --access public --tag beta
        working-directory: packages/core
        env:
          NPM_CONFIG_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish @pleaseai/mcp-gateway
        if: ${{ needs.release-please.outputs.mcp_release_created == 'true' }}
        run: bun publish --access public --tag beta
        working-directory: packages/mcp
        env:
          NPM_CONFIG_TOKEN: ${{ secrets.NPM_TOKEN }}

  update-homebrew-formula:
    needs: [release-please, build-binaries]
    if: ${{ needs.release-please.outputs.mcp_release_created == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
          repositories: |
            mcp-gateway
            homebrew-tap

      - name: Checkout homebrew-tap repository
        uses: actions/checkout@v4
        with:
          repository: pleaseai/homebrew-tap
          token: ${{ steps.app-token.outputs.token }}
          path: homebrew-tap

      - name: Configure git
        run: |
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update Formula
        run: |
          VERSION=${{ needs.release-please.outputs.mcp_tag_name }}
          VERSION_NO_V=${VERSION#v}

          # Download checksums (with -f to fail on HTTP errors)
          curl -fsSL -o darwin-x64.sha256 \
            "https://github.com/${{ github.repository }}/releases/download/${VERSION}/mcp-gateway-darwin-x64.sha256"
          curl -fsSL -o darwin-arm64.sha256 \
            "https://github.com/${{ github.repository }}/releases/download/${VERSION}/mcp-gateway-darwin-arm64.sha256"
          curl -fsSL -o linux-x64.sha256 \
            "https://github.com/${{ github.repository }}/releases/download/${VERSION}/mcp-gateway-linux-x64.sha256"
          curl -fsSL -o linux-arm64.sha256 \
            "https://github.com/${{ github.repository }}/releases/download/${VERSION}/mcp-gateway-linux-arm64.sha256"

          # Extract checksums
          DARWIN_X64_SHA256=$(cat darwin-x64.sha256 | awk '{print $1}')
          DARWIN_ARM64_SHA256=$(cat darwin-arm64.sha256 | awk '{print $1}')
          LINUX_X64_SHA256=$(cat linux-x64.sha256 | awk '{print $1}')
          LINUX_ARM64_SHA256=$(cat linux-arm64.sha256 | awk '{print $1}')

          # Create or update Formula
          cd homebrew-tap
          cat > mcp-gateway.rb << 'FORMULA_EOF'
class McpGateway < Formula
  desc "MCP server and CLI for searching tools using regex, BM25, or semantic search"
  homepage "https://github.com/pleaseai/mcp-gateway"
  version "VERSION_PLACEHOLDER"
  license "MIT"

  on_macos do
    if Hardware::CPU.arm?
      url "https://github.com/pleaseai/mcp-gateway/releases/download/vVERSION_PLACEHOLDER/mcp-gateway-darwin-arm64"
      sha256 "SHA256_DARWIN_ARM64_PLACEHOLDER"
    else
      url "https://github.com/pleaseai/mcp-gateway/releases/download/vVERSION_PLACEHOLDER/mcp-gateway-darwin-x64"
      sha256 "SHA256_DARWIN_X64_PLACEHOLDER"
    end
  end

  on_linux do
    if Hardware::CPU.arm?
      url "https://github.com/pleaseai/mcp-gateway/releases/download/vVERSION_PLACEHOLDER/mcp-gateway-linux-arm64"
      sha256 "SHA256_LINUX_ARM64_PLACEHOLDER"
    else
      url "https://github.com/pleaseai/mcp-gateway/releases/download/vVERSION_PLACEHOLDER/mcp-gateway-linux-x64"
      sha256 "SHA256_LINUX_X64_PLACEHOLDER"
    end
  end

  def install
    if OS.mac?
      if Hardware::CPU.arm?
        bin.install "mcp-gateway-darwin-arm64" => "mcp-gateway"
      else
        bin.install "mcp-gateway-darwin-x64" => "mcp-gateway"
      end
    else
      if Hardware::CPU.arm?
        bin.install "mcp-gateway-linux-arm64" => "mcp-gateway"
      else
        bin.install "mcp-gateway-linux-x64" => "mcp-gateway"
      end
    end
  end

  test do
    assert_match version.to_s, shell_output("#{bin}/mcp-gateway --version")
  end
end
FORMULA_EOF

          # Replace placeholders
          sed -i "s/VERSION_PLACEHOLDER/${VERSION_NO_V}/g" mcp-gateway.rb
          sed -i "s/SHA256_DARWIN_X64_PLACEHOLDER/${DARWIN_X64_SHA256}/" mcp-gateway.rb
          sed -i "s/SHA256_DARWIN_ARM64_PLACEHOLDER/${DARWIN_ARM64_SHA256}/" mcp-gateway.rb
          sed -i "s/SHA256_LINUX_X64_PLACEHOLDER/${LINUX_X64_SHA256}/" mcp-gateway.rb
          sed -i "s/SHA256_LINUX_ARM64_PLACEHOLDER/${LINUX_ARM64_SHA256}/" mcp-gateway.rb

          # Check if there are changes
          if git diff --quiet mcp-gateway.rb 2>/dev/null; then
            echo "No changes to Formula"
            exit 0
          fi

          # Commit and push
          git add mcp-gateway.rb
          git commit -m "chore: update mcp-gateway to ${VERSION}"
          git push origin main
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
